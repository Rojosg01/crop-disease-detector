<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Crop Disease Detector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl mx-auto">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
            <header class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Smart Crop Disease Detector</h1>
                <p class="text-gray-500 mt-2">Get an instant, localized diagnosis and sustainable treatment plan for your crops.</p>
            </header>

            <!-- Main Content: Uploader and Results -->
            <main>
                <!-- Step 1: Input Section -->
                <div id="input-section" class="mb-6">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center bg-gray-50">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                        <label for="image-upload" class="mt-4 block text-sm font-medium text-green-600 hover:text-green-500 cursor-pointer">
                            Upload a leaf image
                            <input id="image-upload" name="image-upload" type="file" class="sr-only" accept="image/*">
                        </label>
                         <p class="text-xs text-gray-500 mt-1">PNG, JPG, GIF up to 10MB</p>
                    </div>

                    <!-- Image Preview -->
                    <div id="image-preview-container" class="mt-4 hidden relative">
                        <img id="image-preview" src="#" alt="Image Preview" class="max-h-64 w-auto mx-auto rounded-lg shadow-md"/>
                        <button id="remove-image-button" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1.5 shadow-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" aria-label="Remove image">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <!-- Location Input -->
                    <div class="mt-4">
                        <label for="location-input" class="block text-sm font-medium text-gray-700">Your Location (e.g., Village, State)</label>
                        <input type="text" id="location-input" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Khanapara, Meghalaya">
                    </div>
                </div>

                <!-- Analyze Button -->
                <button id="analyze-button" disabled class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Analyze Image
                </button>

                <!-- Loading Spinner -->
                <div id="loader" class="mt-6 text-center hidden">
                    <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-600 mt-2">Analyzing... This may take a moment.</p>
                </div>

                <!-- Results Section -->
                <div id="results-section" class="mt-8 hidden">
                    <!-- Diagnosis -->
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Diagnosis</h2>
                        <div id="diagnosis-result" class="mt-2 text-gray-700 bg-gray-50 p-4 rounded-lg"></div>
                    </div>
                    <!-- Treatment -->
                    <div class="mt-6">
                        <h2 class="text-xl font-bold text-gray-800">Sustainable Treatment Plan</h2>
                        <div id="treatment-result" class="mt-2 text-gray-700 bg-gray-50 p-4 rounded-lg space-y-2"></div>
                    </div>
                </div>
                
                <!-- "Ask the Expert" Chat Section -->
                <div id="chat-section" class="mt-8 hidden">
                    <h2 class="text-xl font-bold text-gray-800 text-center">Ask the Expert</h2>
                    <p class="text-center text-gray-500 text-sm mb-4">Ask a follow-up question about your diagnosis.</p>
                    
                    <div id="chat-window" class="h-64 border rounded-lg bg-gray-50 p-4 overflow-y-auto mb-4 flex flex-col space-y-4">
                        <!-- Chat messages will be appended here -->
                    </div>
                    
                    <div class="flex">
                        <input type="text" id="chat-input" class="flex-grow block w-full px-3 py-2 bg-white border border-gray-300 rounded-l-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="e.g., How often should I apply this?">
                        <button id="chat-send-button" class="px-4 py-2 border border-transparent rounded-r-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Send
                        </button>
                    </div>
                </div>

                 <!-- Error Message -->
                 <div id="error-message" class="mt-6 text-center text-red-600 bg-red-100 p-4 rounded-lg hidden"></div>
            </main>
        </div>
    </div>

    <script>
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageButton = document.getElementById('remove-image-button');
        const locationInput = document.getElementById('location-input');
        const analyzeButton = document.getElementById('analyze-button');
        const loader = document.getElementById('loader');
        const resultsSection = document.getElementById('results-section');
        const diagnosisResult = document.getElementById('diagnosis-result');
        const treatmentResult = document.getElementById('treatment-result');
        const errorMessage = document.getElementById('error-message');

        // Chat elements
        const chatSection = document.getElementById('chat-section');
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send-button');

        let base64ImageData = null;
        let conversationHistory = [];

        // Check if both fields are filled to enable the button
        const checkInputs = () => {
            analyzeButton.disabled = !(base64ImageData && locationInput.value.trim() !== '');
        };
        
        function removeImage() {
            imagePreview.src = '#';
            imagePreviewContainer.classList.add('hidden');
            base64ImageData = null;
            imageUpload.value = null; // Resets the file input
            checkInputs();
        }

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    imagePreview.src = event.target.result;
                    imagePreviewContainer.classList.remove('hidden');
                    base64ImageData = event.target.result.split(',')[1];
                    checkInputs();
                };
                reader.readAsDataURL(file);
            }
        });

        locationInput.addEventListener('input', checkInputs);
        removeImageButton.addEventListener('click', removeImage);

        analyzeButton.addEventListener('click', analyzeImage);
        chatSendButton.addEventListener('click', handleChat);
        chatInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                handleChat();
            }
        });

        async function analyzeImage() {
            // Reset state
            resultsSection.classList.add('hidden');
            chatSection.classList.add('hidden');
            errorMessage.classList.add('hidden');
            loader.classList.remove('hidden');
            analyzeButton.disabled = true;

            const location = locationInput.value.trim();
            
            const userPrompt = `
                You are an expert agricultural advisor. Identify the plant disease from the attached image of a crop leaf.
                My location is: ${location}.

                Provide a concise diagnosis and recommend sustainable, eco-friendly treatment options that are specifically relevant to my location. 
                Consider the local climate, common agricultural practices, and locally available resources in your recommendations.

                Structure your response exactly as follows, using '---' as a separator:
                DIAGNOSIS: [Disease Name]
                ---
                TREATMENT:
                - [Step 1]
                - [Step 2]
                - [Step 3, etc.]
            `;
            
            conversationHistory = [{
                role: "user",
                parts: [
                    { text: userPrompt },
                    { inlineData: { mimeType: "image/jpeg", data: base64ImageData } }
                ]
            }];

            try {
                const response = await callGeminiAPI(conversationHistory);

                // Add model response to history
                conversationHistory.push({ role: "model", parts: [{ text: response }] });
                
                displayResults(response);
                chatWindow.innerHTML = ''; // Clear previous chat
                addMessageToChat('bot', "I've analyzed your image. Feel free to ask any follow-up questions!");
                chatSection.classList.remove('hidden');

            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = 'Failed to analyze the image. Please check your connection or try a different image.';
                errorMessage.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
                analyzeButton.disabled = false;
            }
        }

        async function handleChat() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            addMessageToChat('user', userMessage);
            chatInput.value = '';
            
            conversationHistory.push({ role: "user", parts: [{ text: userMessage }] });

            
            const thinkingIndicator = addMessageToChat('bot', 'Thinking...');

            try {
                const response = await callGeminiAPI(conversationHistory);

                conversationHistory.push({ role: "model", parts: [{ text: response }] });
                thinkingIndicator.textContent = response;

            } catch(error) {
                console.error('Error in chat:', error);
                thinkingIndicator.textContent = 'Sorry, I encountered an error. Please try again.';
                thinkingIndicator.classList.add('text-red-600');
            }
        }
        
        async function callGeminiAPI(history) {
            
            const apiKey = "AIzaSyC2JYFmNRKJvtZKRSM_FHIBdTsHe19cUZg"; 
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: history
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API Error: ${response.status} ${response.statusText} - ${errorBody}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                 return result.candidates[0].content.parts[0].text;
            } else {
                 throw new Error("Invalid response structure from API.");
            }
        }

        function displayResults(response) {
            const parts = response.split('---');
            if (parts.length < 2) {
                diagnosisResult.textContent = response;
                treatmentResult.textContent = "No specific treatment plan was provided in the response.";
                resultsSection.classList.remove('hidden');
                return;
            }

            const diagnosis = parts[0].replace('DIAGNOSIS:', '').trim();
            const treatment = parts[1].replace('TREATMENT:', '').trim();
            
            diagnosisResult.textContent = diagnosis;

            const treatmentSteps = treatment.split('- ').filter(step => step.trim() !== '');
            treatmentResult.innerHTML = '';
            const list = document.createElement('ul');
            list.className = 'list-disc list-inside space-y-2';
            treatmentSteps.forEach(step => {
                const item = document.createElement('li');
                item.textContent = step.trim();
                list.appendChild(item);
            });
            treatmentResult.appendChild(list);
            
            resultsSection.classList.remove('hidden');
        }

        function addMessageToChat(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('p-3', 'rounded-lg', 'max-w-xs');
            messageElement.textContent = message;

            if (sender === 'user') {
                messageElement.classList.add('bg-green-600', 'text-white', 'self-end', 'ml-auto');
            } else {
                messageElement.classList.add('bg-gray-200', 'text-gray-800', 'self-start', 'mr-auto');
            }
            
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return messageElement;
        }

    </script>
</body>
</html>

